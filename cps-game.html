<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HYPERCLICK ‚Äî Clicks Per Second</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #050a18;
    --panel: rgba(8,20,50,0.7);
    --accent: #00d4ff;
    --accent2: #b845ff;
    --accent3: #ff2d78;
    --gold: #ffd700;
    --silver: #c0c0c0;
    --bronze: #cd7f32;
    --text: #e0eeff;
    --muted: #4a6fa0;
    --glow: 0 0 20px rgba(0,212,255,0.5);
    --glow2: 0 0 20px rgba(184,69,255,0.5);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    font-family: 'Rajdhani', sans-serif;
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    cursor: none;
  }

  input, textarea {
    cursor: text !important;
  }

  /* Custom cursor */
  #cursor {
    position: fixed;
    width: 20px;
    height: 20px;
    border: 2px solid var(--accent);
    border-radius: 50%;
    pointer-events: none;
    z-index: 9999;
    transition: transform 0.1s, border-color 0.2s;
    transform: translate(-50%, -50%);
  }
  #cursor-dot {
    position: fixed;
    width: 4px;
    height: 4px;
    background: var(--accent);
    border-radius: 50%;
    pointer-events: none;
    z-index: 9999;
    transform: translate(-50%, -50%);
  }

  /* Canvas background */
  #bg-canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 0;
    opacity: 0.6;
  }

  /* Layout */
  .app {
    position: relative;
    z-index: 1;
    min-height: 100vh;
    display: grid;
    grid-template-columns: 1fr 380px;
    grid-template-rows: auto 1fr auto;
    gap: 0;
  }

  /* Header */
  header {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 40px;
    border-bottom: 1px solid rgba(0,212,255,0.15);
    background: rgba(5,10,24,0.8);
    backdrop-filter: blur(20px);
  }

  .logo {
    font-family: 'Orbitron', monospace;
    font-size: 22px;
    font-weight: 900;
    letter-spacing: 4px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .logo span {
    display: block;
    font-size: 9px;
    letter-spacing: 8px;
    font-weight: 400;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-top: 2px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 30px;
  }

  .week-timer {
    text-align: right;
  }
  .week-timer .label {
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
  }
  .week-timer .time {
    font-family: 'Orbitron', monospace;
    font-size: 16px;
    color: var(--accent3);
    text-shadow: 0 0 10px var(--accent3);
  }

  /* Main game area */
  .game-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    gap: 30px;
    position: relative;
  }

  /* CPS Display */
  .cps-display {
    text-align: center;
    position: relative;
  }

  .cps-label {
    font-size: 11px;
    letter-spacing: 6px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .cps-number {
    font-family: 'Orbitron', monospace;
    font-size: clamp(60px, 10vw, 110px);
    font-weight: 900;
    line-height: 1;
    background: linear-gradient(135deg, #fff 0%, var(--accent) 50%, var(--accent2) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: none;
    filter: drop-shadow(0 0 30px rgba(0,212,255,0.4));
    transition: transform 0.05s;
  }

  .cps-unit {
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    letter-spacing: 4px;
    color: var(--accent2);
    margin-top: 4px;
  }

  /* Stats row */
  .stats-row {
    display: flex;
    gap: 20px;
    align-items: center;
  }

  .stat-box {
    background: var(--panel);
    border: 1px solid rgba(0,212,255,0.15);
    border-radius: 8px;
    padding: 12px 20px;
    text-align: center;
    backdrop-filter: blur(10px);
    transition: border-color 0.3s;
  }
  .stat-box:hover {
    border-color: rgba(0,212,255,0.4);
  }
  .stat-box .s-label {
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
  }
  .stat-box .s-val {
    font-family: 'Orbitron', monospace;
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    text-shadow: var(--glow);
  }

  /* Click button */
  .btn-wrap {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ring {
    position: absolute;
    border-radius: 50%;
    border: 1px solid var(--accent);
    opacity: 0.2;
    animation: ringPulse 2s ease-out infinite;
  }
  .ring:nth-child(1) { width: 220px; height: 220px; animation-delay: 0s; }
  .ring:nth-child(2) { width: 280px; height: 280px; animation-delay: 0.6s; }
  .ring:nth-child(3) { width: 340px; height: 340px; animation-delay: 1.2s; }

  @keyframes ringPulse {
    0% { transform: scale(0.9); opacity: 0.3; }
    100% { transform: scale(1.2); opacity: 0; }
  }

  .click-btn {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    border: none;
    cursor: none;
    position: relative;
    background: radial-gradient(circle at 35% 35%, rgba(0,212,255,0.3), rgba(184,69,255,0.2), rgba(5,10,24,0.9));
    box-shadow:
      0 0 0 2px rgba(0,212,255,0.4),
      0 0 40px rgba(0,212,255,0.2),
      inset 0 0 40px rgba(0,212,255,0.1);
    transition: transform 0.08s, box-shadow 0.08s;
    user-select: none;
    -webkit-user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 6px;
    overflow: hidden;
    z-index: 2;
  }

  .click-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.15), transparent 60%);
    pointer-events: none;
  }

  .click-btn:active, .click-btn.clicking {
    transform: scale(0.92);
    box-shadow:
      0 0 0 2px var(--accent),
      0 0 60px rgba(0,212,255,0.5),
      0 0 100px rgba(0,212,255,0.2),
      inset 0 0 60px rgba(0,212,255,0.2);
  }

  .click-btn .btn-icon {
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    letter-spacing: 3px;
    color: rgba(0,212,255,0.9);
    text-transform: uppercase;
  }
  .click-btn .btn-hint {
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }

  /* Progress / mode controls */
  .controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .mode-btn {
    background: var(--panel);
    border: 1px solid rgba(0,212,255,0.2);
    color: var(--muted);
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px;
    letter-spacing: 2px;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer !important;
    transition: all 0.2s;
    text-transform: uppercase;
  }
  .mode-btn:hover, .mode-btn.active {
    background: rgba(0,212,255,0.1);
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: var(--glow);
  }

  /* Timer bar */
  .timer-section {
    width: 100%;
    max-width: 460px;
  }

  .timer-bar-wrap {
    width: 100%;
    height: 4px;
    background: rgba(0,212,255,0.1);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 8px;
  }

  .timer-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 2px;
    width: 100%;
    transform-origin: left;
    transition: width 0.1s linear;
    box-shadow: 0 0 10px var(--accent);
  }

  .timer-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .timer-label {
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
  }
  .timer-val {
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    color: var(--accent);
  }

  /* Submit section */
  .submit-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 100%;
    max-width: 460px;
  }

  .name-input {
    background: var(--panel);
    border: 1px solid rgba(0,212,255,0.2);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    letter-spacing: 2px;
    padding: 12px 20px;
    border-radius: 6px;
    width: 100%;
    text-align: center;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    text-transform: uppercase;
  }
  .name-input::placeholder { color: var(--muted); }
  .name-input:focus {
    border-color: var(--accent);
    box-shadow: var(--glow);
  }

  .submit-btn {
    background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(184,69,255,0.2));
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    letter-spacing: 4px;
    padding: 14px 40px;
    border-radius: 6px;
    cursor: none;
    transition: all 0.2s;
    text-transform: uppercase;
    width: 100%;
    box-shadow: var(--glow);
  }
  .submit-btn:hover {
    background: linear-gradient(135deg, rgba(0,212,255,0.3), rgba(184,69,255,0.3));
    box-shadow: 0 0 30px rgba(0,212,255,0.4);
    transform: translateY(-1px);
  }
  .submit-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .result-msg {
    font-size: 12px;
    letter-spacing: 2px;
    color: var(--accent2);
    text-align: center;
    min-height: 20px;
    text-shadow: var(--glow2);
  }

  /* Leaderboard panel */
  .leaderboard-panel {
    background: rgba(5,10,24,0.85);
    border-left: 1px solid rgba(0,212,255,0.12);
    backdrop-filter: blur(20px);
    display: flex;
    flex-direction: column;
    padding: 0;
    overflow: hidden;
    grid-row: 2 / 4;
  }

  .lb-header {
    padding: 28px 28px 20px;
    border-bottom: 1px solid rgba(0,212,255,0.1);
    position: relative;
    overflow: hidden;
  }

  .lb-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(184,69,255,0.06) 0%, transparent 70%);
    pointer-events: none;
  }

  .lb-title {
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    letter-spacing: 5px;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .lb-subtitle {
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }

  .lb-live-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    background: var(--accent3);
    border-radius: 50%;
    margin-right: 6px;
    box-shadow: 0 0 8px var(--accent3);
    animation: blink 1s ease-in-out infinite;
    vertical-align: middle;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .lb-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px 0;
  }

  .lb-list::-webkit-scrollbar { width: 3px; }
  .lb-list::-webkit-scrollbar-track { background: transparent; }
  .lb-list::-webkit-scrollbar-thumb { background: rgba(0,212,255,0.3); border-radius: 2px; }

  .lb-entry {
    display: grid;
    grid-template-columns: 36px 1fr auto;
    align-items: center;
    padding: 12px 24px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    transition: background 0.2s;
    animation: entryIn 0.4s ease-out;
    gap: 10px;
  }

  @keyframes entryIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .lb-entry:hover {
    background: rgba(0,212,255,0.04);
  }

  .lb-entry.rank-1 { background: rgba(255,215,0,0.04); }
  .lb-entry.rank-2 { background: rgba(192,192,192,0.04); }
  .lb-entry.rank-3 { background: rgba(205,127,50,0.04); }

  .lb-rank {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    font-weight: 700;
    text-align: center;
  }
  .rank-1 .lb-rank { color: var(--gold); text-shadow: 0 0 10px rgba(255,215,0,0.5); }
  .rank-2 .lb-rank { color: var(--silver); }
  .rank-3 .lb-rank { color: var(--bronze); }
  .lb-entry:not(.rank-1):not(.rank-2):not(.rank-3) .lb-rank { color: var(--muted); }

  .lb-name {
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 1px;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-transform: uppercase;
  }
  .lb-date {
    font-size: 9px;
    letter-spacing: 1px;
    color: var(--muted);
    margin-top: 2px;
  }

  .lb-cps {
    text-align: right;
  }
  .lb-cps-val {
    font-family: 'Orbitron', monospace;
    font-size: 16px;
    font-weight: 700;
  }
  .rank-1 .lb-cps-val { color: var(--gold); }
  .rank-2 .lb-cps-val { color: var(--silver); }
  .rank-3 .lb-cps-val { color: var(--bronze); }
  .lb-entry:not(.rank-1):not(.rank-2):not(.rank-3) .lb-cps-val { color: var(--accent); }

  .lb-cps-unit {
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }

  .lb-empty {
    padding: 40px 24px;
    text-align: center;
    color: var(--muted);
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .lb-footer {
    padding: 16px 24px;
    border-top: 1px solid rgba(0,212,255,0.1);
    text-align: center;
  }

  .lb-reset-info {
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }
  .lb-entries-count {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    color: var(--accent2);
    margin-top: 4px;
  }

  /* Footer */
  footer {
    grid-column: 1;
    padding: 20px 40px;
    border-top: 1px solid rgba(0,212,255,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(5,10,24,0.8);
    backdrop-filter: blur(20px);
  }
  .footer-text {
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
  }

  /* Click particles */
  .click-particle {
    position: fixed;
    pointer-events: none;
    z-index: 9998;
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    color: var(--accent);
    font-size: 14px;
    text-shadow: 0 0 10px var(--accent);
    animation: particleFly 0.8s ease-out forwards;
  }

  @keyframes particleFly {
    0% { opacity: 1; transform: translate(0, 0) scale(1); }
    100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.5); }
  }

  /* Scanlines overlay */
  .scanlines {
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.03) 2px,
      rgba(0,0,0,0.03) 4px
    );
    pointer-events: none;
    z-index: 100;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .app {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr auto auto;
    }
    .leaderboard-panel {
      grid-row: auto;
      border-left: none;
      border-top: 1px solid rgba(0,212,255,0.12);
      max-height: 400px;
    }
    footer { grid-column: 1; }
    header { padding: 16px 20px; }
    .game-area { padding: 24px 16px; }
  }

  @media (max-width: 480px) {
    .stats-row { flex-wrap: wrap; justify-content: center; }
    .controls { flex-wrap: wrap; justify-content: center; }
  }

  /* State: test running */
  body.test-active .click-btn {
    animation: btnGlow 0.5s ease-in-out infinite alternate;
  }
  @keyframes btnGlow {
    from { box-shadow: 0 0 0 2px rgba(0,212,255,0.4), 0 0 40px rgba(0,212,255,0.2); }
    to { box-shadow: 0 0 0 2px var(--accent), 0 0 80px rgba(0,212,255,0.4), 0 0 120px rgba(0,212,255,0.1); }
  }

  .best-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: linear-gradient(135deg, var(--accent3), var(--accent2));
    color: white;
    font-family: 'Orbitron', monospace;
    font-size: 8px;
    letter-spacing: 1px;
    padding: 3px 8px;
    border-radius: 10px;
    text-transform: uppercase;
    display: none;
    box-shadow: 0 0 15px rgba(255,45,120,0.5);
    animation: badgePop 0.3s ease-out;
  }

  @keyframes badgePop {
    from { transform: scale(0); }
    to { transform: scale(1); }
  }

  .grade {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    letter-spacing: 4px;
    margin-top: 4px;
    color: var(--accent2);
  }

  /* ====== RESULTS MODAL ====== */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(2,5,14,0.85);
    backdrop-filter: blur(12px);
    z-index: 5000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .modal {
    background: linear-gradient(135deg, rgba(8,20,50,0.98) 0%, rgba(14,8,40,0.98) 100%);
    border: 1px solid rgba(0,212,255,0.25);
    border-radius: 16px;
    padding: 48px 40px 40px;
    max-width: 460px;
    width: 90%;
    position: relative;
    box-shadow: 0 0 60px rgba(0,212,255,0.15), 0 0 120px rgba(184,69,255,0.1);
    transform: scale(0.9) translateY(20px);
    transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
    text-align: center;
  }
  .modal-overlay.open .modal {
    transform: scale(1) translateY(0);
  }

  .modal::before {
    content: '';
    position: absolute;
    top: 0; left: 50%; transform: translateX(-50%);
    width: 60%;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  .modal-tag {
    font-size: 10px;
    letter-spacing: 5px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 20px;
  }

  .modal-cps {
    font-family: 'Orbitron', monospace;
    font-size: 72px;
    font-weight: 900;
    line-height: 1;
    background: linear-gradient(135deg, #fff 0%, var(--accent) 60%, var(--accent2) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 0 20px rgba(0,212,255,0.4));
    margin-bottom: 4px;
  }

  .modal-unit {
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    letter-spacing: 5px;
    color: var(--accent2);
    margin-bottom: 8px;
  }

  .modal-grade {
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    letter-spacing: 5px;
    margin-bottom: 28px;
  }

  .modal-stats {
    display: flex;
    gap: 12px;
    margin-bottom: 32px;
    justify-content: center;
  }
  .modal-stat {
    background: rgba(0,212,255,0.05);
    border: 1px solid rgba(0,212,255,0.12);
    border-radius: 8px;
    padding: 10px 18px;
    flex: 1;
  }
  .modal-stat .ms-label {
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .modal-stat .ms-val {
    font-family: 'Orbitron', monospace;
    font-size: 18px;
    color: var(--accent);
  }

  .modal-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(0,212,255,0.2), transparent);
    margin-bottom: 28px;
  }

  .modal-submit-label {
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 14px;
  }

  .modal-name-input {
    background: rgba(0,212,255,0.05);
    border: 1px solid rgba(0,212,255,0.25);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 18px;
    letter-spacing: 3px;
    padding: 14px 20px;
    border-radius: 8px;
    width: 100%;
    text-align: center;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    text-transform: uppercase;
    margin-bottom: 12px;
    cursor: text !important;
  }
  .modal-name-input::placeholder { color: var(--muted); }
  .modal-name-input:focus {
    border-color: var(--accent);
    box-shadow: var(--glow);
  }

  .modal-actions {
    display: flex;
    gap: 10px;
  }

  .modal-submit-btn {
    flex: 2;
    background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(184,69,255,0.15));
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    letter-spacing: 3px;
    padding: 14px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    box-shadow: var(--glow);
  }
  .modal-submit-btn:hover {
    background: linear-gradient(135deg, rgba(0,212,255,0.25), rgba(184,69,255,0.25));
    box-shadow: 0 0 30px rgba(0,212,255,0.4);
  }
  .modal-submit-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .modal-retry-btn {
    flex: 1;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--muted);
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    padding: 14px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }
  .modal-retry-btn:hover {
    border-color: rgba(255,255,255,0.2);
    color: var(--text);
  }

  .modal-result-msg {
    margin-top: 12px;
    font-size: 12px;
    letter-spacing: 2px;
    color: var(--accent2);
    min-height: 18px;
    text-shadow: var(--glow2);
  }

  .modal-new-best {
    display: inline-block;
    background: linear-gradient(135deg, var(--accent3), var(--accent2));
    color: white;
    font-family: 'Orbitron', monospace;
    font-size: 9px;
    letter-spacing: 2px;
    padding: 4px 12px;
    border-radius: 20px;
    text-transform: uppercase;
    margin-bottom: 16px;
    box-shadow: 0 0 20px rgba(255,45,120,0.4);
    animation: badgePop 0.4s cubic-bezier(0.34,1.56,0.64,1);
  }
  /* ====== PAYPAL / DONATION ====== */
  .donate-banner {
    grid-column: 1 / -1;
    background: linear-gradient(90deg, rgba(0,212,255,0.06), rgba(184,69,255,0.06));
    border-bottom: 1px solid rgba(0,212,255,0.1);
    padding: 10px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
  }
  .donate-text {
    font-size: 12px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }
  .donate-text strong {
    color: var(--accent2);
  }
  .donate-btns {
    display: flex;
    gap: 8px;
  }
  .donate-btn {
    background: transparent;
    border: 1px solid rgba(184,69,255,0.4);
    color: var(--accent2);
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    padding: 7px 16px;
    border-radius: 4px;
    cursor: pointer !important;
    transition: all 0.2s;
    text-transform: uppercase;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .donate-btn:hover {
    background: rgba(184,69,255,0.15);
    border-color: var(--accent2);
    box-shadow: var(--glow2);
    transform: translateY(-1px);
  }
  .donate-btn svg { width:14px; height:14px; fill: currentColor; }

  /* In-modal donation */
  .modal-donate-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(0,212,255,0.1);
    text-align: center;
  }
  .modal-donate-label {
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 12px;
  }
  .modal-donate-amounts {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .modal-donate-amt {
    background: rgba(184,69,255,0.07);
    border: 1px solid rgba(184,69,255,0.25);
    color: var(--accent2);
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    letter-spacing: 1px;
    padding: 9px 18px;
    border-radius: 6px;
    cursor: pointer !important;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
  }
  .modal-donate-amt:hover {
    background: rgba(184,69,255,0.2);
    border-color: var(--accent2);
    box-shadow: var(--glow2);
    transform: translateY(-2px);
  }
  .paypal-logo {
    font-size: 9px;
    letter-spacing: 1px;
    color: var(--muted);
    margin-top: 8px;
    display: block;
  }

  /* Floating donate button */
  .floating-donate {
    position: fixed;
    bottom: 28px;
    right: 28px;
    z-index: 4000;
  }
  .floating-donate-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, rgba(184,69,255,0.2), rgba(0,212,255,0.15));
    border: 1px solid rgba(184,69,255,0.4);
    color: var(--accent2);
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    padding: 11px 18px;
    border-radius: 30px;
    text-decoration: none;
    transition: all 0.25s;
    box-shadow: 0 0 20px rgba(184,69,255,0.2), 0 4px 20px rgba(0,0,0,0.4);
    backdrop-filter: blur(10px);
    cursor: pointer !important;
  }
  .floating-donate-btn:hover {
    background: linear-gradient(135deg, rgba(184,69,255,0.35), rgba(0,212,255,0.25));
    border-color: var(--accent2);
    box-shadow: 0 0 30px rgba(184,69,255,0.4), 0 4px 20px rgba(0,0,0,0.4);
    transform: translateY(-2px);
    color: #d88fff;
  }
  .floating-donate-btn svg {
    width: 14px;
    height: 14px;
    fill: currentColor;
    flex-shrink: 0;
  }

  @media (max-width: 900px) {
    .floating-donate { bottom: 16px; right: 16px; }
  }
</style>
</head>
<body>
<div id="cursor"></div>
<div id="cursor-dot"></div>
<canvas id="bg-canvas"></canvas>
<div class="scanlines"></div>

<div class="app">
  <header>
    <div class="logo">
      HYPERCLICK
      <span>Clicks Per Second</span>
    </div>
    <div class="header-right">
      <div class="week-timer">
        <div class="label">Leaderboard resets in</div>
        <div class="time" id="week-countdown">‚Äî</div>
      </div>
    </div>
  </header>

  <main class="game-area">
    <div class="cps-display">
      <div class="cps-label">Clicks Per Second</div>
      <div class="cps-number" id="cps-display">0.00</div>
      <div class="cps-unit">CPS</div>
      <div class="grade" id="grade-display"></div>
    </div>

    <div class="stats-row">
      <div class="stat-box">
        <div class="s-label">Total Clicks</div>
        <div class="s-val" id="total-clicks">0</div>
      </div>
      <div class="stat-box" style="position:relative">
        <div class="s-label">Best CPS</div>
        <div class="s-val" id="best-cps">0.00</div>
        <div class="best-badge" id="best-badge">NEW BEST</div>
      </div>
      <div class="stat-box">
        <div class="s-label">Time Left</div>
        <div class="s-val" id="time-left">‚Äî</div>
      </div>
    </div>

    <div class="timer-section">
      <div class="timer-info">
        <span class="timer-label" id="timer-status">Select Duration</span>
        <span class="timer-val" id="timer-val"></span>
      </div>
      <div class="timer-bar-wrap">
        <div class="timer-bar" id="timer-bar" style="width:0%"></div>
      </div>
    </div>

    <div class="controls">
      <button class="mode-btn active" data-time="5">5s</button>
      <button class="mode-btn" data-time="10">10s</button>
      <button class="mode-btn" data-time="15">15s</button>
      <button class="mode-btn" data-time="30">30s</button>
      <button class="mode-btn" data-time="60">60s</button>
    </div>

    <div class="btn-wrap">
      <div class="ring"></div>
      <div class="ring"></div>
      <div class="ring"></div>
      <button class="click-btn" id="click-btn">
        <div class="btn-icon">CLICK</div>
        <div class="btn-hint">Start Here</div>
      </button>
    </div>
  </main>

  <footer>
    <div class="footer-text">Press <strong>Space</strong> or click the button</div>
    <div class="footer-text">Top 50 per week</div>
  </footer>

  <!-- Leaderboard -->
  <aside class="leaderboard-panel">
    <div class="lb-header">
      <div class="lb-title"><span class="lb-live-dot"></span>Live Leaderboard</div>
      <div class="lb-subtitle">Weekly Top Scores ‚Äî Resets Every Monday</div>
    </div>
    <div class="lb-list" id="lb-list">
      <div class="lb-empty">Loading scores...</div>
    </div>
    <div class="lb-footer">
      <div class="lb-reset-info">Resets Monday 00:00 UTC</div>
      <div class="lb-entries-count" id="lb-count">‚Äî entries</div>
    </div>
  </aside>
</div>

<!-- Results Modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-tag">Test Complete</div>
    <div id="modal-new-best" class="modal-new-best" style="display:none">üèÜ New Personal Best!</div>
    <div class="modal-cps" id="modal-cps">0.00</div>
    <div class="modal-unit">CPS</div>
    <div class="modal-grade" id="modal-grade"></div>
    <div class="modal-stats">
      <div class="modal-stat">
        <div class="ms-label">Clicks</div>
        <div class="ms-val" id="modal-clicks">0</div>
      </div>
      <div class="modal-stat">
        <div class="ms-label">Duration</div>
        <div class="ms-val" id="modal-duration">5s</div>
      </div>
      <div class="modal-stat">
        <div class="ms-label">Best Ever</div>
        <div class="ms-val" id="modal-best">0.00</div>
      </div>
    </div>
    <div class="modal-divider"></div>
    <div class="modal-submit-label">Submit to Leaderboard</div>
    <input type="text" class="modal-name-input" id="modal-player-name" placeholder="Enter Your Name" maxlength="20" autocomplete="off">
    <div class="modal-actions">
      <button class="modal-submit-btn" id="modal-submit-btn" onclick="submitScore()">Submit Score</button>
      <button class="modal-retry-btn" onclick="closeModalAndReset()">Try Again</button>
    </div>
    <div class="modal-result-msg" id="modal-result-msg"></div>
    <div class="modal-donate-section">
      <div class="modal-donate-label">‚ö° Enjoying HYPERCLICK? Support the dev</div>
      <div class="modal-donate-amounts">
        <a class="modal-donate-amt" href="https://paypal.me/sandy871983/1" target="_blank" rel="noopener">$1</a>
        <a class="modal-donate-amt" href="https://paypal.me/sandy871983/5" target="_blank" rel="noopener">$5</a>
        <a class="modal-donate-amt" href="https://paypal.me/sandy871983/10" target="_blank" rel="noopener">$10</a>
        <a class="modal-donate-amt" href="https://paypal.me/sandy871983" target="_blank" rel="noopener">Custom</a>
      </div>
      <span class="paypal-logo">via PayPal ¬∑ secure ¬∑ no account needed</span>
    </div>
  </div>
</div>

<!-- Floating donate button -->
<div class="floating-donate" id="floating-donate">
  <a href="https://paypal.me/sandy871983" target="_blank" rel="noopener" class="floating-donate-btn">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42a3.35 3.35 0 0 0-.607-.541c-.013.076-.026.175-.041.254-.93 4.778-4.005 7.201-9.138 7.201h-2.19a.563.563 0 0 0-.556.479l-1.187 7.527h-.506l-.24 1.516a.56.56 0 0 0 .554.647h3.882c.46 0 .85-.334.922-.788.06-.26.76-4.852.816-5.09a.932.932 0 0 1 .923-.788h.58c3.76 0 6.705-1.528 7.565-5.946.36-1.847.174-3.388-.777-4.471z"/></svg>
    Support
  </a>
</div>

<script>
// ====== BACKGROUND CANVAS ======
const canvas = document.getElementById('bg-canvas');
const ctx = canvas.getContext('2d');
let W, H, particles = [], lines = [];

function resizeCanvas() {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

for (let i = 0; i < 60; i++) {
  particles.push({
    x: Math.random() * W, y: Math.random() * H,
    vx: (Math.random()-0.5)*0.3, vy: (Math.random()-0.5)*0.3,
    r: Math.random() * 1.5 + 0.3,
    c: Math.random() > 0.5 ? `rgba(0,212,255,` : `rgba(184,69,255,`
  });
}

// Grid lines
for (let i = 0; i < 8; i++) {
  lines.push({ x: 0, y: i/8, hor: true, phase: Math.random()*Math.PI*2 });
  lines.push({ x: i/8, y: 0, hor: false, phase: Math.random()*Math.PI*2 });
}

let animT = 0;
function drawBg() {
  ctx.clearRect(0, 0, W, H);
  animT += 0.005;

  // Grid
  ctx.lineWidth = 0.5;
  lines.forEach(l => {
    const alpha = 0.03 + 0.02*Math.sin(animT + l.phase);
    ctx.strokeStyle = `rgba(0,212,255,${alpha})`;
    ctx.beginPath();
    if (l.hor) { ctx.moveTo(0, l.y*H); ctx.lineTo(W, l.y*H); }
    else { ctx.moveTo(l.x*W, 0); ctx.lineTo(l.x*W, H); }
    ctx.stroke();
  });

  // Particles
  particles.forEach(p => {
    p.x += p.vx; p.y += p.vy;
    if (p.x < 0) p.x = W; if (p.x > W) p.x = 0;
    if (p.y < 0) p.y = H; if (p.y > H) p.y = 0;
    const alpha = 0.4 + 0.4*Math.sin(animT*2 + p.x);
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fillStyle = p.c + alpha + ')';
    ctx.fill();
  });

  // Connections
  ctx.lineWidth = 0.3;
  for (let i = 0; i < particles.length; i++) {
    for (let j = i+1; j < particles.length; j++) {
      const dx = particles[i].x - particles[j].x;
      const dy = particles[i].y - particles[j].y;
      const dist = Math.sqrt(dx*dx+dy*dy);
      if (dist < 120) {
        const alpha = (1 - dist/120) * 0.08;
        ctx.strokeStyle = `rgba(0,212,255,${alpha})`;
        ctx.beginPath();
        ctx.moveTo(particles[i].x, particles[i].y);
        ctx.lineTo(particles[j].x, particles[j].y);
        ctx.stroke();
      }
    }
  }

  requestAnimationFrame(drawBg);
}
drawBg();

// ====== CUSTOM CURSOR ======
const cursor = document.getElementById('cursor');
const cursorDot = document.getElementById('cursor-dot');
document.addEventListener('mousemove', e => {
  cursor.style.left = e.clientX + 'px';
  cursor.style.top = e.clientY + 'px';
  cursorDot.style.left = e.clientX + 'px';
  cursorDot.style.top = e.clientY + 'px';
});

document.addEventListener('mousedown', () => {
  cursor.style.transform = 'translate(-50%,-50%) scale(0.7)';
  cursor.style.borderColor = 'var(--accent3)';
  cursorDot.style.background = 'var(--accent3)';
});
document.addEventListener('mouseup', () => {
  cursor.style.transform = 'translate(-50%,-50%) scale(1)';
  cursor.style.borderColor = 'var(--accent)';
  cursorDot.style.background = 'var(--accent)';
});

// ====== GAME LOGIC ======
let duration = 5;
let testRunning = false;
let testDone = false;
let clicks = 0;
let startTime = null;
let timerInterval = null;
let finalCPS = 0;
let bestCPS = parseFloat(localStorage.getItem('bestCPS') || '0');
let submitted = false;

const cpsDisplay = document.getElementById('cps-display');
const totalClicksEl = document.getElementById('total-clicks');
const bestCpsEl = document.getElementById('best-cps');
const timeLeftEl = document.getElementById('time-left');
const timerBar = document.getElementById('timer-bar');
const timerStatus = document.getElementById('timer-status');
const timerValEl = document.getElementById('timer-val');
const clickBtn = document.getElementById('click-btn');
const gradeEl = document.getElementById('grade-display');
const bestBadge = document.getElementById('best-badge');

bestCpsEl.textContent = bestCPS.toFixed(2);

// Attach click handler once, cleanly
clickBtn.addEventListener('click', function(e) {
  if (testDone) return; // blocked while modal is showing
  handleClick(e);
});

// Wire duration buttons via event listeners (not inline onclick ‚Äî avoids cursor:none conflicts)
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.stopPropagation();
    setDuration(+this.dataset.time);
  });
});

function setDuration(d) {
  if (testRunning) return; // only block mid-test, never block on testDone
  duration = d;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', +b.dataset.time === d));
  // If test is done, fully reset so player can start fresh with new duration
  if (testDone) {
    document.getElementById('modal-overlay').classList.remove('open');
    resetGame();
  } else {
    timerBar.style.width = '0%';
    timerBar.style.background = 'linear-gradient(90deg, var(--accent), var(--accent2))';
    timerStatus.textContent = `${d}s Test`;
    timerValEl.textContent = '';
  }
}
setDuration(5);

function getGrade(cps) {
  if (cps < 3) return { label: 'NOVICE', color: '#4a6fa0' };
  if (cps < 6) return { label: 'APPRENTICE', color: '#00d4ff' };
  if (cps < 9) return { label: 'ADVANCED', color: '#b845ff' };
  if (cps < 12) return { label: 'EXPERT', color: '#ff2d78' };
  if (cps < 15) return { label: 'ELITE', color: '#ffd700' };
  return { label: 'GODLIKE', color: '#fff' };
}

function handleClick(e) {
  if (testDone) return;

  if (!testRunning) {
    startTest();
  }

  clicks++;
  const elapsed = (Date.now() - startTime) / 1000;
  const cps = elapsed > 0 ? clicks / elapsed : 0;

  cpsDisplay.textContent = cps.toFixed(2);
  totalClicksEl.textContent = clicks;

  // Pulse
  cpsDisplay.style.transform = 'scale(1.04)';
  setTimeout(() => cpsDisplay.style.transform = 'scale(1)', 60);

  // Grade
  const grade = getGrade(cps);
  gradeEl.textContent = '‚Äî ' + grade.label + ' ‚Äî';
  gradeEl.style.color = grade.color;

  // Always spawn particles from the button center
  const btnRect = clickBtn.getBoundingClientRect();
  const btnCX = btnRect.left + btnRect.width / 2;
  const btnCY = btnRect.top + btnRect.height / 2;
  spawnParticle(btnCX, btnCY);

  // Add canvas burst particles from button center too
  for (let i = 0; i < 3; i++) {
    particles.push({
      x: btnCX + (Math.random()-0.5)*40,
      y: btnCY + (Math.random()-0.5)*40,
      vx: (Math.random()-0.5)*2,
      vy: (Math.random()-0.5)*2,
      r: Math.random() * 2 + 1,
      c: Math.random() > 0.5 ? 'rgba(0,212,255,' : 'rgba(184,69,255,'
    });
    if (particles.length > 120) particles.shift();
  }
}

function spawnParticle(x, y) {
  const el = document.createElement('div');
  el.className = 'click-particle';
  const angle = Math.random() * Math.PI * 2;
  const dist = 40 + Math.random() * 60;
  el.style.setProperty('--dx', Math.cos(angle)*dist + 'px');
  el.style.setProperty('--dy', Math.sin(angle)*dist - 30 + 'px');
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.textContent = '+1';
  el.style.color = Math.random() > 0.5 ? 'var(--accent)' : 'var(--accent2)';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 800);
}

function startTest() {
  testRunning = true;
  submitted = false;
  startTime = Date.now();
  document.body.classList.add('test-active');
  document.getElementById('modal-result-msg').textContent = '';

  clickBtn.querySelector('.btn-hint').textContent = 'Keep Going!';

  const endTime = startTime + duration * 1000;

  timerInterval = setInterval(() => {
    const now = Date.now();
    const remaining = Math.max(0, endTime - now);
    const pct = ((duration * 1000 - remaining) / (duration * 1000)) * 100;
    timerBar.style.width = pct + '%';
    const secs = Math.ceil(remaining / 1000);
    timeLeftEl.textContent = secs + 's';
    timerValEl.textContent = secs + 's';

    if (remaining <= 0) {
      clearInterval(timerInterval);
      endTest();
    }
  }, 50);
}

function endTest() {
  testRunning = false;
  testDone = true; // LOCK clicks immediately
  document.body.classList.remove('test-active');

  const elapsed = duration;
  finalCPS = clicks / elapsed;
  cpsDisplay.textContent = finalCPS.toFixed(2);
  timeLeftEl.textContent = '0s';

  // Grade
  const grade = getGrade(finalCPS);
  gradeEl.textContent = '‚Äî ' + grade.label + ' ‚Äî';
  gradeEl.style.color = grade.color;

  // Best
  let isNewBest = false;
  if (finalCPS > bestCPS) {
    bestCPS = finalCPS;
    localStorage.setItem('bestCPS', bestCPS.toFixed(2));
    bestCpsEl.textContent = bestCPS.toFixed(2);
    isNewBest = true;
  }

  timerBar.style.width = '100%';
  timerBar.style.background = 'linear-gradient(90deg, var(--accent2), var(--accent3))';
  timerStatus.textContent = 'COMPLETE';

  clickBtn.querySelector('.btn-icon').textContent = 'DONE';
  clickBtn.querySelector('.btn-hint').textContent = 'See Results';

  // Open modal after short delay so last click registers
  setTimeout(() => openModal(isNewBest), 300);
}

function openModal(isNewBest) {
  const grade = getGrade(finalCPS);
  document.getElementById('modal-cps').textContent = finalCPS.toFixed(2);
  document.getElementById('modal-grade').textContent = '‚Äî ' + grade.label + ' ‚Äî';
  document.getElementById('modal-grade').style.color = grade.color;
  document.getElementById('modal-clicks').textContent = clicks;
  document.getElementById('modal-duration').textContent = duration + 's';
  document.getElementById('modal-best').textContent = bestCPS.toFixed(2);
  document.getElementById('modal-new-best').style.display = isNewBest ? 'inline-block' : 'none';
  document.getElementById('modal-submit-btn').disabled = false;
  document.getElementById('modal-submit-btn').textContent = 'Submit Score';
  document.getElementById('modal-result-msg').textContent = '';

  const overlay = document.getElementById('modal-overlay');
  overlay.classList.add('open');

  // Focus name input after animation
  setTimeout(() => {
    document.getElementById('modal-player-name').focus();
  }, 350);
}

function closeModalAndReset() {
  document.getElementById('modal-overlay').classList.remove('open');
  setTimeout(resetGame, 300);
}

function resetGame() {
  testDone = false;
  testRunning = false;
  clicks = 0;
  finalCPS = 0;
  clearInterval(timerInterval);

  cpsDisplay.textContent = '0.00';
  totalClicksEl.textContent = '0';
  timeLeftEl.textContent = '‚Äî';
  timerBar.style.width = '0%';
  timerBar.style.background = 'linear-gradient(90deg, var(--accent), var(--accent2))';
  timerStatus.textContent = `${duration}s Test`;
  timerValEl.textContent = '';
  gradeEl.textContent = '';
  clickBtn.querySelector('.btn-icon').textContent = 'CLICK';
  clickBtn.querySelector('.btn-hint').textContent = 'Start Here';
  bestBadge.style.display = 'none';
}

// Space bar ‚Äî only fires once per press (e.repeat blocks held-down auto-repeat)
document.addEventListener('keydown', e => {
  if (e.code === 'Space' && !e.target.matches('input')) {
    e.preventDefault();
    if (e.repeat) return; // ignore held-down key repeat
    if (testDone) return;
    const btnRect = clickBtn.getBoundingClientRect();
    const fakeEvt = {
      clientX: btnRect.left + btnRect.width / 2,
      clientY: btnRect.top + btnRect.height / 2
    };
    handleClick(fakeEvt);
    clickBtn.classList.add('clicking');
    setTimeout(() => clickBtn.classList.remove('clicking'), 100);
  }
});

// ====== WEEK COUNTDOWN ======
function getWeekReset() {
  const now = new Date();
  const utcDay = now.getUTCDay(); // 0=Sun, 1=Mon
  const daysToMonday = utcDay === 0 ? 1 : (8 - utcDay);
  const reset = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + daysToMonday));
  return reset;
}

function updateCountdown() {
  const reset = getWeekReset();
  const diff = reset - new Date();
  const d = Math.floor(diff/86400000);
  const h = Math.floor((diff%86400000)/3600000);
  const m = Math.floor((diff%3600000)/60000);
  const s = Math.floor((diff%60000)/1000);
  document.getElementById('week-countdown').textContent =
    `${d}d ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
setInterval(updateCountdown, 1000);
updateCountdown();

// ====== LEADERBOARD (Persistent Storage) ======
const LB_KEY = 'leaderboard-data';
const SHARED = true;

function getWeekKey() {
  const d = new Date();
  const jan1 = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  const week = Math.ceil(((d - jan1) / 86400000 + 1) / 7);
  return `${d.getUTCFullYear()}-W${week}-v2`;
}

async function loadLeaderboard() {
  const weekKey = getWeekKey();
  const storageKey = `leaderboard-${weekKey}`;
  try {
    const result = await window.storage.get(storageKey, SHARED);
    const entries = result ? JSON.parse(result.value) : [];
    renderLeaderboard(entries);
    return entries;
  } catch {
    renderLeaderboard([]);
    return [];
  }
}

async function submitScore() {
  if (submitted) return;
  const name = document.getElementById('modal-player-name').value.trim();
  if (!name) {
    document.getElementById('modal-result-msg').textContent = 'Please enter your name first';
    document.getElementById('modal-player-name').focus();
    return;
  }
  if (finalCPS <= 0) return;

  const btn = document.getElementById('modal-submit-btn');
  btn.disabled = true;
  btn.textContent = 'Submitting...';
  document.getElementById('modal-result-msg').textContent = '';

  const weekKey = getWeekKey();
  const storageKey = `leaderboard-${weekKey}`;

  try {
    let entries = await loadLeaderboard();
    const newEntry = {
      name: name.toUpperCase().substring(0, 20),
      cps: Math.round(finalCPS * 100) / 100,
      duration: duration,
      date: new Date().toISOString().split('T')[0],
      ts: Date.now()
    };

    entries.push(newEntry);
    entries.sort((a,b) => b.cps - a.cps);
    entries = entries.slice(0, 50);

    await window.storage.set(storageKey, JSON.stringify(entries), SHARED);
    renderLeaderboard(entries);

    const rank = entries.findIndex(e => e.ts === newEntry.ts) + 1;
    document.getElementById('modal-result-msg').textContent =
      rank <= 3 ? `üî• RANK #${rank} ‚Äî INCREDIBLE!` : `You're ranked #${rank} this week!`;

    submitted = true;
    btn.textContent = '‚úì Submitted!';
  } catch (err) {
    document.getElementById('modal-result-msg').textContent = 'Error submitting. Try again.';
    btn.disabled = false;
    btn.textContent = 'Submit Score';
  }
}

function renderLeaderboard(entries) {
  const list = document.getElementById('lb-list');
  const countEl = document.getElementById('lb-count');
  countEl.textContent = `${entries.length} / 50 entries`;

  if (!entries.length) {
    list.innerHTML = '<div class="lb-empty">No scores yet this week.<br>Be the first!</div>';
    return;
  }

  list.innerHTML = entries.map((e, i) => {
    const rank = i + 1;
    const rankClass = rank <= 3 ? `rank-${rank}` : '';
    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
    return `
      <div class="lb-entry ${rankClass}">
        <div class="lb-rank">${medal}</div>
        <div>
          <div class="lb-name">${e.name}</div>
          <div class="lb-date">${e.date} ¬∑ ${e.duration}s test</div>
        </div>
        <div class="lb-cps">
          <div class="lb-cps-val">${e.cps.toFixed(2)}</div>
          <div class="lb-cps-unit">CPS</div>
        </div>
      </div>
    `;
  }).join('');
}

// Auto-refresh leaderboard every 15s
loadLeaderboard();
setInterval(loadLeaderboard, 15000);
</script>
</body>
</html>
